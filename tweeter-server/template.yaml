AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: SAM config for Tweeter server


#
# Global Lambda function properties. These apply to every Lambda function.
#
Globals:
  Function:
    Runtime: nodejs20.x
    CodeUri: ./dist/
    Layers:
      - !Ref tweeterLayer
    Timeout: 30
    MemorySize: 128


#
# Reusable blocks of configuration. These are referenced throughout the template to avoid duplication.
# &identifier is used to define a reusable block, and *identifier is used to reference it.
#
Metadata:
  x-common-policies: &commonPolicies
    - AWSLambdaBasicExecutionRole
    - AmazonSESFullAccess
    - CloudWatchFullAccess
    - AmazonDynamoDBFullAccess
    - AmazonS3FullAccess
    - AmazonSQSFullAccess

  # +++ THIS IS THE FIX +++
  # This block is used for the 200, 400, 500, etc. responses.
  # It MUST only contain 'Access-Control-Allow-Origin'.
  x-common-cors-headers: &commonCorsHeaders
    method.response.header.Access-Control-Allow-Origin: "'*'"
  # ++++++++++++++++++++++

  x-common-swagger-response-headers: &commonSwaggerResponseHeaders
    Access-Control-Allow-Origin:
      type: string
    # +++ THIS IS THE FIX +++
    # The 'OPTIONS' response *also* needs to list the allowed headers/methods.
    Access-Control-Allow-Headers:
      type: string
    Access-Control-Allow-Methods:
      type: string
    # ++++++++++++++++++++++


#
# AWS resource definitions
#
Resources:


  #
  # Web API
  #

  tweeterApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: tweeterApi
      StageName: prod
      # +++ THIS IS THE FIX +++
      # This block correctly defines the global CORS policy,
      # including 'OPTIONS' for the preflight request.
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
      # ++++++++++++++++++++++
      DefinitionBody:
        swagger: "2.0"
        info:
          title: "Tweeter API"
          version: "1.0"
        x-common-consumes: &commonConsumes
          - application/json
        x-common-produces: &commonProduces
          - application/json
        x-common-request-templates: &commonRequestTemplates
          application/json: $input.json('$')
        x-common-amazon-responses: &commonAmazonResponses
          default:
            statusCode: 200
            responseParameters: *commonCorsHeaders
          ".*bad-request.*":
            statusCode: 400
            responseParameters: *commonCorsHeaders
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
          ".*unauthorized.*":
            statusCode: 401
            responseParameters: *commonCorsHeaders
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
          ".*internal-server-error.*":
            statusCode: 500
            responseParameters: *commonCorsHeaders
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
        x-common-swagger-responses: &commonSwaggerResponses
          "200":
            description: "OK"
            headers: *commonSwaggerResponseHeaders
          "400":
            description: "Bad Request"
            headers: *commonSwaggerResponseHeaders
          "401":
            description: "Unauthorized"
            headers: *commonSwaggerResponseHeaders
          "500":
            description: "Internal Server Error"
            headers: *commonSwaggerResponseHeaders
        paths:

          #
          # Endpoint definitions
          #

          /user/get:  ##### TODO: Change "/user/get" to the actual endpoint URL
            post:
              summary: Get user profile by alias
              description: Returns a user's profile (first name, last name, alias, imageUrl) given their alias.
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  ##### TODO: Change "userGetFunction" to the actual function name. (Don't delete the $, {}, or .Arn suffix.)
                  ##### The function name must agree with the "Web API Lambda functions" section below.
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${userGetFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'

          /user/create:  ##### TODO: Set endpoint URL
            post:
              summary: Register new user
              description: Registers a new user account and returns an auth token. For M3 this is simulated.
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  ##### TODO: Set function name
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${userCreateFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'
          #
          # +++ YOUR "GET FOLLOWERS" API PATH +++
          #
          /followee/list:
            post:
              summary: List followees (paged)
              description: Returns a page of users that the target user follows.
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  # This name 'GetFollowersFunction' MUST match the Lambda function name below
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetFollowersFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'
          
          /follower/list:
            post:
              summary: List followers (paged)
              description: Returns a page of users that follow the target user.
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FollowersListFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'

          /follow/isfollower:
            post:
              summary: Check follower relationship
              description: Returns whether followerAlias is following followeeAlias.
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IsFollowerFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'

          /follow/follow:
            post:
              summary: Follow user
              description: Causes actorAlias to follow targetAlias and returns new counts.
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FollowFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'

          /follow/unfollow:
            post:
              summary: Unfollow user
              description: Causes actorAlias to unfollow targetAlias and returns new counts.
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UnfollowFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'

          /follow/follower/count:
            post:
              summary: Get follower count
              description: Returns the number of followers for the target user.
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FollowerCountFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'

          /follow/followee/count:
            post:
              summary: Get followee count
              description: Returns the number of followees for the target user.
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FolloweeCountFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'
          # +++++++++++++++++++++++++++++++++++++++++++++++

          /user/login:
            post:
              summary: Sign in user
              description: Signs in the user with alias/password and returns an auth token. Returns 400 when alias is empty.
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LoginFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'

          /user/logout:
            post:
              summary: Sign out user
              description: Signs out the current user (simulated for M3).
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LogoutFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'

          /status/post:
            post:
              summary: Post a new status
              description: Posts a new status update to the feed/story (simulated for M3).
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${PostStatusFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'

          /feed/list:
            post:
              summary: Get feed items (paged)
              description: Returns a page of most recent statuses for the userâ€™s feed.
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FeedListFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'

          /story/list:
            post:
              summary: Get story items (paged)
              description: Returns a page of most recent statuses authored by the user.
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${StoryListFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses
            options:
              consumes: *commonConsumes
              produces: *commonProduces
              responses:
                "200":
                  description: "CORS support"
                  headers: *commonSwaggerResponseHeaders
              x-amazon-apigateway-integration:
                type: mock
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: 200
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
                    responseTemplates:
                      application/json: '{}'


  #
  # SQS Queues  (This will become relevant in Milestone 4. For M3, leave this section commented out.)
  #

  #   MyQueue:
  #     Type: AWS::SQS::Queue
  #     Properties:
  #       QueueName: MyQueue


  #
  # Lambda Layer (reused by all Lambda functions)
  #
  tweeterLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: tweeterLayer
      Description: dependencies layer for Tweeter server
      ContentUri: ./layer/
      CompatibleRuntimes:
        - nodejs20.x
      RetentionPolicy: DELETE


  #
  # Web API Lambda functions
  #

  userGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: userGetFunction
      Handler: lambda/AuthHandlers.getUserHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/get
            Method: POST

  userCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: userCreateFunction
      Handler: lambda/AuthHandlers.registerHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/create
            Method: POST

  #
  # +++ YOUR "GET FOLLOWERS" LAMBDA FUNCTION +++
  #
  GetFollowersFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: GetFollowersFunction
      # This points to your 'dist/lambda/GetFollowersHandler.js' file
      Handler: lambda/GetFollowersHandler.handler
      Policies: *commonPolicies
      # NOTE: We do *not* add an 'Events:' block here, because
      # we already defined the API path in the 'DefinitionBody' above.
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /followee/list
            Method: POST
  # ++++++++++++++++++++++++++++++++++++++++++++++++++++

  # Additional Lambda functions
  FollowersListFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: FollowersListFunction
      Handler: lambda/FollowHandlers.followersListHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follower/list
            Method: POST

  IsFollowerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: IsFollowerFunction
      Handler: lambda/FollowHandlers.isFollowerHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/isfollower
            Method: POST

  FollowFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: FollowFunction
      Handler: lambda/FollowHandlers.followHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/follow
            Method: POST

  UnfollowFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: UnfollowFunction
      Handler: lambda/FollowHandlers.unfollowHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/unfollow
            Method: POST

  FollowerCountFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: FollowerCountFunction
      Handler: lambda/FollowHandlers.followerCountHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/follower/count
            Method: POST

  FolloweeCountFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: FolloweeCountFunction
      Handler: lambda/FollowHandlers.followeeCountHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/followee/count
            Method: POST

  LoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: LoginFunction
      Handler: lambda/AuthHandlers.loginHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/login
            Method: POST

  LogoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: LogoutFunction
      Handler: lambda/AuthHandlers.logoutHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/logout
            Method: POST

  PostStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: PostStatusFunction
      Handler: lambda/AuthHandlers.postStatusHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /status/post
            Method: POST

  FeedListFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: FeedListFunction
      Handler: lambda/StatusHandlers.feedListHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /feed/list
            Method: POST

  StoryListFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: StoryListFunction
      Handler: lambda/StatusHandlers.storyListHandler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /story/list
            Method: POST


  #
  # SQS Queue Lambda Functions  (This will become relevant in Milestone 4. For M3, leave this section commented out.)
  #

  #   MyQueueFunction:
  #     Type: AWS::Serverless::Function
  #     Properties:
  #       FunctionName: MyQueueFunction
  #       Handler: <PATH TO LAMBDA HANDLER>
  #       Policies: *commonPolicies
  #       Events:
  #         SQSTrigger:
  #           Type: SQS
  #           Properties:
  #             Queue: !GetAtt MyQueue.Arn
  #             Enabled: true


  #
  # DynamoDB Tables
  #

  visitTable:  ##### TODO: Change "visitTable" to match the table name. This doesn't
               #####       need to be the actual table name, just a unique identifier.
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: visit  ##### TODO: Set the actual table name. This is what your code will use to identify this table.
      AttributeDefinitions:
        ##### TODO: Add any attributes that will be used as partition or sort keys for the table or any indexes.
        - AttributeName: person_name
          AttributeType: S  ##### TODO: Set the data type for this attribute. S for string, N for number, etc.
        - AttributeName: place_name
          AttributeType: S
      KeySchema:
        - AttributeName: person_name  ##### TODO: Set the table partition key name
          KeyType: HASH
        - AttributeName: place_name  ##### TODO: Set the table sort key name. Delete these
          KeyType: RANGE             #####       two lines if the table has no sort key.
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 1   ##### TODO: Set the table's Read and Write capacities. Leaving these at
        WriteCapacityUnits: 1  #####       one is fine for now, but you may need to change them later.
      ##### TODO: If you don't need an index for this table, delete the GlobalSecondaryIndexes property and all its subproperties.
      GlobalSecondaryIndexes:
        - IndexName: place_index  ##### TODO: Set the actual index name. This is what your code will use to identify this index.
          KeySchema:
            - AttributeName: place_name  ##### TODO: Set the index partition key name
              KeyType: HASH
            - AttributeName: person_name  ##### TODO: Set the index sort key name. Delete these
              KeyType: RANGE              #####       two lines if the index has no sort key.
          ProvisionedThroughput:
            ReadCapacityUnits: 1   ##### TODO: Same thing. Indexes have their own read/write
            WriteCapacityUnits: 1  #####       capacities that you may need to change.
          Projection:
            ProjectionType: ALL

  followTable:  ##### TODO: Change to match the table name
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: follows
      AttributeDefinitions:
        - AttributeName: follower_alias
          AttributeType: S
        - AttributeName: followee_alias
          AttributeType: S
      KeySchema:
        - AttributeName: follower_alias  ##### TODO: Set table partition key
          KeyType: HASH
        - AttributeName: followee_alias  ##### TODO: Set table sort key
          KeyType: RANGE
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      GlobalSecondaryIndexes:
        - IndexName: follows_alias_index # Renamed for clarity
          KeySchema:
            - AttributeName: followee_alias  ##### TODO: Set index partition key
              KeyType: HASH
            - AttributeName: follower_alias  ##### TODO: Set index sort key
              KeyType: RANGE
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
          Projection:
            ProjectionType: ALL

  #
  # TODO: ADD MORE TABLE DEFINITIONS HERE
  #
  
#
# +++ THE OUTPUTS BLOCK +++
#
Outputs:
  TweeterApi:
    Description: "API Gateway endpoint URL for Tweeter"
    Value: !Sub "https://${tweeterApi}.execute-api.${AWS::Region}.amazonaws.com/prod"
# ++++++++++++++++++++++++++++++++